package application;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;

import javafx.collections.FXCollections;
import javafx.collections.ObservableList;

import java.sql.*;
import java.util.Properties;

public class Datasource   {
	
        public static final String url = "jdbc:mysql://livepromotio.mysql.database.azure.com/ticket_system";
        public static final String user = "lukelive@livepromotio";
        public static final String password = "Live1972";
        
        public static final String TABLE_USERS = "users";
        public static final String COLUMN_USER_USERNAME = "username";
        public static final String COLUMN_USER_PASSWORD = "password";
        
        public static final String TABLE_EVENTS = "events";
        public static final String COLUMN_EVENT_NAME = "eventName";
        public static final String COLUMN_EVENT_STARTDATETIME = "eventStartDateTime";
        public static final String COLUMN_EVENT_ENDDATETIME = "eventEndDateTime";
        public static final String COLUMN_EVENT_CREATED = "eventCreated";
        public static final String COLUMN_EVENT_INFO = "eventInfo";
        public static final String COLUMN_EVENT_TC = "eventTC";
        
        public static final String TABLE_VENUES = "venues";
        public static final String COLUMN_VENUE_ADDRESSLINEONE = "venueAddressLineOne";
        public static final String COLUMN_VENUE_ADDRESSLINETWO = "venueAddressLineTwo";        
        public static final String COLUMN_VENUE_POSTCODE = "venuePostcode";
        public static final String COLUMN_VENUE_TOWNCITY = "venueTownCity";
        public static final String COLUMN_VENUE_TEL = "venueTel";
        public static final String COLUMN_VENUE_EMAIL = "venueEmail";
        
        private Connection conn;
        
        public boolean open(){
        try{
            // Set connection properties.
            Properties properties = new Properties();
            properties.setProperty("user", user);
            properties.setProperty("password", password);
            properties.setProperty("useSSL", "true");
            properties.setProperty("verifyServerCertificate", "true");
            properties.setProperty("requireSSL", "false");

            // get connection
            conn = DriverManager.getConnection(url, properties);
          	System.out.println("Successfully connected to database");
        	return true;
        } catch(SQLException e){
        	System.out.println("Failed to connect to database");
        	return false;
        }
        }
        
        public void close() {
        	try{
        		if(conn != null){
        			conn.close();
        		}
        	} catch(SQLException e) {
        		System.out.println("Couldn't close connection" + e.getMessage());
        	}
        }
        
        public ObservableList<Event> queryEvents(){
        	
        	try(Statement statement = conn.createStatement();
        	ResultSet results = statement.executeQuery("SELECT * FROM " + TABLE_EVENTS)){   		
        		
        		ObservableList<Event> events = FXCollections.observableArrayList();        		
        		while(results.next()){
        			Event event = new Event();
        			event.setEventName(results.getString(COLUMN_EVENT_NAME));
        			event.setEventStartDate(results.getString(COLUMN_EVENT_STARTDATETIME));
        			event.setEventEndDate(results.getString(COLUMN_EVENT_ENDDATETIME));
        			event.setVenueAddressLineOne(results.getString(COLUMN_VENUE_ADDRESSLINEONE));
           			event.setVenueAddressLineTwo(results.getString(COLUMN_VENUE_ADDRESSLINETWO));
           			event.setVenuePostcode(results.getString(COLUMN_VENUE_POSTCODE));
           			event.setVenueTel(results.getString(COLUMN_VENUE_TEL));
           			event.setVenueEmail(results.getString(COLUMN_VENUE_EMAIL));
           			event.setEventTC(results.getString(COLUMN_EVENT_TC));
           			event.setEventInfo(results.getString(COLUMN_EVENT_INFO));
        			events.add(event);
        		}
        		
        		return events;
        		
        	} catch(SQLException e) {
        		System.out.println("Query failed:" + e.getMessage());
        		return null;     
        	}
       }

        public List<User> queryUsers(){
        	
        	try(Statement statement = conn.createStatement();
        	ResultSet results = statement.executeQuery("SELECT * FROM " + TABLE_USERS)){   		
        		
        		List<User> users = new ArrayList<>();        		
        		while(results.next()){
        			User user = new User();
        			user.setUsername(results.getString(COLUMN_USER_USERNAME));
        			user.setPassword(results.getString(COLUMN_USER_PASSWORD));
        			users.add(user);
        		}
        		
        		return users;
        		
        	} catch(SQLException e) {
        		System.out.println("Query failed:" + e.getMessage());
        		return null;     
        	}
       }
}
